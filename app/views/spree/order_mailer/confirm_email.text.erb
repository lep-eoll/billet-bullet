<%
  address = @order.user.present? ? @order.user.bill_address : @order.bill_address
  address = @order.bill_address if address.nil?
  user_name = address.firstname + ' ' + address.lastname
%>
Dear <%= user_name %>,


Please note that this email is NOT your ticket. See *Delivery* below for details on where to pick up your ticket.
Thank you for using LEP 2015 online ticketing system. This email confirms your purchase and receipt of your payment. Please save this receipt for your records

 Here are the details of your order:
============================================================
<%= Spree.t('order_mailer.confirm_email.order_summary') %>
============================================================
<% @order.line_items.each do |item| %>
  <%= raw(item.variant.product.name) %> (<%=item.quantity%>) @ <%= item.single_money %> = <%= item.display_amount %>
<% end %>
============================================================
<%= Spree.t('order_mailer.confirm_email.subtotal') %> <%= @order.display_item_total %>
<% if @order.line_item_adjustments.exists? %>
  <% if @order.all_adjustments.promotion.eligible.exists? %>
    <% @order.all_adjustments.promotion.eligible.group_by(&:label).each do |label, adjustments| %>
<%= Spree.t(:promotion) %>: <%= label %> <%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %>
    <% end %>
  <% end %>
<% end %>

<% @order.shipments.group_by { |s| s.selected_shipping_rate.try(:name) }.each do |name, shipments| %>
<%= Spree.t(:shipping) %>: <%= name %> <%= Spree::Money.new(shipments.sum(&:discounted_cost), currency: @order.currency) %>
<% end %>

<% if @order.all_adjustments.eligible.tax.exists? %>
  <% @order.all_adjustments.eligible.tax.group_by(&:label).each do |label, adjustments| %>
<%= Spree.t(:tax) %>: <%= label %> <%= Spree::Money.new(adjustments.sum(&:amount), currency: @order.currency) %>
  <% end %>
<% end %>

<% @order.adjustments.eligible.each do |adjustment| %>
  <% next if (adjustment.source_type == 'Spree::TaxRate') and (adjustment.amount == 0) %>
<%= adjustment.label %> <%= adjustment.display_amount %>
<% end %>
============================================================

Delivery of Tickets

Purchased tickets will be available for pickup at the Festival registration area in the Hilton Hotel from Aug 4th - 8th, 2015. Please ensure you pick up your tickets at least 1 hour prior to the start of the performance. Tickets are non-refundable and have no cash value. Should you have any questions about your purchase, please email info@lep2015.com.<br/>
We look forward to seeing you in Whistler this summer as we celebrate Estonia on the West Coast.

Regards,
The LEP 2015 Vancouver/Whistler Organizing Committee
